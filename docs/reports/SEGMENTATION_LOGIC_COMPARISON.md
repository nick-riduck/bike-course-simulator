# 세그먼트 분할 로직 비교 분석 및 개선안 (PRO-744/PRO-814)

## 1. 개요
본 문서는 GPX 시뮬레이터 및 코스 생성기 통합 파이프라인 구축을 위한 **'세그먼트 분할(Segmentation)'** 로직을 정의한다.
물리 엔진의 정확도 확보, 3D 시각화 품질 개선, 그리고 시스템 간 데이터 정합성을 목표로 한다.

---

## 2. 로직 비교 및 최종 확정안

| 비교 항목 | ① 현재 코드 (`src/gpx_loader.py`) | ② Jira 명세 (PRO-744) | ③ **[확정] 통합 파이프라인 로직** |
| :--- | :--- | :--- | :--- |
| **데이터 소스** | 로컬 GPX 파싱 | 로컬 GPX 파싱 | **Valhalla API** (Trace/Route) |
| **노면 (Crr) 반영** | ❌ 불가 | ❌ 언급 없음 | ✅ **Surface/Use 변경 시 분할** |
| **경사도(Grade) 기준** | 0.5% (고정) | 0.5% | **0.5% (Configurable)** <sup>*1</sup> |
| **방향(Heading) 기준** | 15도 (버그 있음) | 15도 | **10.0도 (Configurable)** <sup>*2</sup> |
| **최대 길이 제한** | 1000m (버그 있음) | 200m | **200m (Configurable)** |
| **시스템 통합** | 시뮬레이터 전용 | 시뮬레이터 전용 | **시뮬레이터 & 생성기 공통 적용** |

> **설계 의도:**
> *   *1: DEM 데이터의 노이즈를 고려한 최소 임계값. 환경 변수를 통해 0.2%~0.3% 등 미세 조정 가능하도록 설계.*
> *   *2: 완만한 코너링 감지 및 물리 엔진의 감속 로직 리얼리티 확보를 위해 10도로 강화.*

---

## 3. 핵심 비즈니스 로직

### 3.1. 통합 파서 (Unified Parser) 원칙
*   **Single Source of Truth:** 시뮬레이터(GPX 업로드)와 코스 생성기(지도 클릭)는 동일한 파서 로직을 공유한다.
*   **표준 JSON 출력:** 입력 경로가 다르더라도 최종 출력 포맷(`Atomic Segments`)은 완벽하게 일치해야 한다.
*   **성능:** O(N) 단일 순회(One-pass scan) 방식으로 구현하여 실시간 응답성을 확보한다.

### 3.2. 분할 규칙 (Splitting Rules) - OR 조건
다음 조건 중 하나라도 만족하면 세그먼트를 분할한다.

1.  **🛣️ 노면(Surface) 변화:** Valhalla가 제공하는 `surface` 속성이 변할 때.
2.  **📐 경사도(Grade) 변화:** 이전 세그먼트 대비 설정된 임계값(기본 0.5%) 이상 변할 때. (노이즈 방지를 위해 이동평균 필터 적용)
3.  **🔄 방향(Heading) 변화:** 주행 방향이 설정된 임계값(기본 10도) 이상 변할 때. (Wrap-around 보정 적용)
4.  **📏 최대 길이 제한:** 세그먼트 길이가 설정된 임계값(기본 200m)에 도달할 때.

### 3.3. 가변 파라미터 설계 (Flexibility)
하드코딩을 배제하고 다음 환경 변수를 통해 로직을 제어한다.
*   `SIM_SEGMENT_GRADE_THRESHOLD` (Default: 0.005)
*   `SIM_SEGMENT_HEADING_THRESHOLD` (Default: 10.0)
*   `SIM_SEGMENT_MAX_LENGTH` (Default: 200.0)

---

## 4. 물리 엔진과의 상호작용
*   **Backend:** 속성(Grade, Crr)이 균일한 'Atomic Segment'를 생성하여 전달.
*   **Physics Engine:** 전달받은 세그먼트를 내부적으로 **20m 단위(Sub-stepping)**로 정밀하게 나누어 물리 연산 수행.
*   **Result:** 데이터 파편화를 최소화하면서도 물리적 정확도와 시각화 품질을 동시에 확보.

작성일: 2026-02-05
작성자: Gemini CLI Agent
